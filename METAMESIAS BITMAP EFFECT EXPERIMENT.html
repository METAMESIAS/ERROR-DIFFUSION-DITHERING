<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>METAMESIAS BITMAP EFFECT EXPERIMENT</title>
</head>
<body>
    <h1>METAMESIAS BITMAP EFFECT EXPERIMENT</h1>

    <!-- Input untuk mengupload gambar -->
    <input type="file" id="upload" accept="image/*">

    <hr>

    <!-- Kontainer untuk menampilkan canvas dan tombol download -->
    <div id="canvas-container"></div>

    <script>
        document.getElementById('upload').addEventListener('change', function(event) {
            // Reset canvas-container
            const container = document.getElementById('canvas-container');
            while (container.firstChild) {
                container.removeChild(container.firstChild);
            }

            const file = event.target.files[0];
            const img = new Image();

            img.onload = function() {
                const newWidth = 360;
                const scaleFactor = newWidth / img.width;
                const newHeight = img.height * scaleFactor;

                // Dithering Types
                const ditheringTypes = [
                    { name: 'Bayer 2x2', method: applyBayerMatrixDithering, matrix: bayerMatrix2x2 },
                    { name: 'Bayer 4x4', method: applyBayerMatrixDithering, matrix: bayerMatrix4x4 },
                    { name: 'Bayer 8x8', method: applyBayerMatrixDithering, matrix: bayerMatrix8x8 },
                    { name: 'Error Diffusion', method: applyErrorDiffusionDithering }
                ];

                ditheringTypes.forEach(type => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    canvas.width = newWidth;
                    canvas.height = newHeight;
                    ctx.drawImage(img, 0, 0, newWidth, newHeight);

                    // Apply Dithering
                    type.method(ctx, newWidth, newHeight, type.matrix);

                    // Scale Up
                    scaleImage(canvas, ctx, newWidth, newHeight, 3);

                    // Append Canvas and Button
                    appendCanvasAndButton(type.name, canvas);
                });
            };

            img.src = URL.createObjectURL(file);
        });

        function applyBayerMatrixDithering(ctx, width, height, matrix) {
            const imageData = ctx.getImageData(0, 0, width, height);
            const data = imageData.data;
            const matrixSize = Math.sqrt(matrix.length);

            for (let y = 0; y < height; y++) {
                for (let x = 0; x < width; x++) {
                    const index = (y * width + x) * 4;
                    const oldPixel = data[index];
                    const matrixValue = matrix[(y % matrixSize) * matrixSize + (x % matrixSize)];
                    const threshold = (matrixValue / 255) * 255;
                    const newPixel = oldPixel < threshold ? 0 : 255;
                    data[index] = newPixel;
                    data[index + 1] = newPixel;
                    data[index + 2] = newPixel;
                    data[index + 3] = 255;
                }
            }

            ctx.putImageData(imageData, 0, 0);
        }

        function applyErrorDiffusionDithering(ctx, width, height) {
            const imageData = ctx.getImageData(0, 0, width, height);
            const data = imageData.data;

            for (let y = 0; y < height; y++) {
                for (let x = 0; x < width; x++) {
                    const index = (y * width + x) * 4;
                    const oldPixel = data[index];
                    const newPixel = oldPixel < 128 ? 0 : 255;
                    const error = oldPixel - newPixel;

                    data[index] = newPixel;
                    data[index + 1] = newPixel;
                    data[index + 2] = newPixel;
                    data[index + 3] = 255;

                    if (x + 1 < width) data[(y * width + (x + 1)) * 4] += error * 7 / 16;
                    if (y + 1 < height) {
                        if (x > 0) data[((y + 1) * width + (x - 1)) * 4] += error * 3 / 16;
                        data[((y + 1) * width + x) * 4] += error * 5 / 16;
                        if (x + 1 < width) data[((y + 1) * width + (x + 1)) * 4] += error * 1 / 16;
                    }
                }
            }

            ctx.putImageData(imageData, 0, 0);
        }

        function scaleImage(canvas, ctx, width, height, scale) {
            const scaledWidth = width * scale;
            const scaledHeight = height * scale;

            const scaledCanvas = document.createElement('canvas');
            const scaledCtx = scaledCanvas.getContext('2d');

            scaledCanvas.width = scaledWidth;
            scaledCanvas.height = scaledHeight;

            scaledCtx.imageSmoothingEnabled = false;
            scaledCtx.drawImage(canvas, 0, 0, width, height, 0, 0, scaledWidth, scaledHeight);

            canvas.width = scaledWidth;
            canvas.height = scaledHeight;
            ctx.drawImage(scaledCanvas, 0, 0);
        }

        function appendCanvasAndButton(name, canvas) {
            const container = document.getElementById('canvas-container');
            const div = document.createElement('div');

            const label = document.createElement('p');
            label.textContent = name;
            div.appendChild(label);

            // Ensure canvas is responsive
            canvas.style.width = "100%";
            canvas.style.height = "auto";

            div.appendChild(canvas);

            const button = document.createElement('button');
            button.textContent = `Download ${name}`;
            button.addEventListener('click', () => downloadCanvasAsImage(canvas, name));
            div.appendChild(button);

            container.appendChild(div);
        }

        function downloadCanvasAsImage(canvas, name) {
            const link = document.createElement('a');
            link.href = canvas.toDataURL();
            link.download = `${name}.png`;
            link.click();
        }

        // Bayer matrices
        const bayerMatrix2x2 = [
            0, 128,
            192, 64
        ];

        const bayerMatrix4x4 = [
            0, 128, 32, 160,
            192, 64, 224, 96,
            48, 176, 16, 144,
            240, 112, 208, 80
        ];

        const bayerMatrix8x8 = [
            0, 32, 8, 40, 2, 34, 10, 42,
            48, 16, 56, 24, 50, 18, 58, 26,
            12, 44, 4, 36, 14, 46, 6, 38,
            60, 28, 52, 20, 62, 30, 54, 22,
            3, 35, 11, 43, 1, 33, 9, 41,
            51, 19, 59, 27, 49, 17, 57, 25,
            15, 47, 7, 39, 13, 45, 5, 37,
            63, 31, 55, 23, 61, 29, 53, 21
        ].map(x => x * 4);
    </script>
</body>
</html>